# Floor Plan Recognition Service

Прототип системы распознавания планов помещений для **ООО Refloor**.

**Автор:** Стреколовский Максим Владимирович  
**Дата:** 10.12.2025  
**Статус:** Prototype / Proof of Concept

---

## Задача

Автоматическое извлечение структуры стен из изображений планов помещений (квартиры, офисы).

**Входные данные:** JPG/PNG изображения планов  
**Выходной формат:**
```json
{
  "meta": { "source": "plan.png" },
  "walls": [
    { "id": "w1", "points": [[x1,y1], [x2,y2]] }
  ]
}
```

---

## Pipeline обработки

### Этап 1: Preprocessing
```
Входное изображение
    ↓
CLAHE (усиление контраста)
    ↓
Bilateral filter (сглаживание с сохранением границ)
    ↓
Otsu + Adaptive thresholding (бинаризация)
    ↓
Morphological operations (удаление шума)
    ↓
Бинарное изображение
```

### Этап 2: Wall Detection
```
Бинарное изображение
    ↓
Skeletonization (scikit-image thin)
    ↓
Probabilistic Hough Transform
  • threshold=30 (низкий порог для внутренних стен)
  • minLineLength=20
  • maxLineGap=35
    ↓
Snap to axis (выравнивание по 0°/45°/90°/135°)
    ↓
Deduplication (удаление дубликатов)
    ↓
Merge collinear segments (слияние коллинеарных линий)
    ↓
JSON output
```

---

## Технологический стек

### Используемые инструменты:

| Компонент | Технология | Почему выбрано |
|-----------|-----------|----------------|
| **Wall Detection** | OpenCV Hough Transform | Классический CV метод, быстрый, интерпретируемый |
| **Preprocessing** | OpenCV (CLAHE, bilateral, morphology) | Стандарт индустрии для обработки изображений |
| **Room Segmentation** | SAM 2.1 Large (Meta) | SOTA zero-shot сегментация (2024) |
| **OCR** | EasyOCR | Лучшая open-source альтернатива Tesseract |
| **Backend** | FastAPI | Быстрый, современный Python web framework |
| **Interface** | Telegram Bot | Простой UX без веб-разработки |
| **Deployment** | Docker | Воспроизводимая среда, простое развёртывание |

### Архитектура:
```
Telegram Bot
    ↓
[Hybrid Service:8003] ← основной сервис
    ↓
Hough Transform → стены
SAM2 + OCR → комнаты (не используется в текущей версии)
```

---

## Текущие ограничения и проблемы

### Критические проблемы точности:

1. **Внутренние стены часто пропускаются**
   - Hough Transform плохо справляется с разрывами в линиях
   - Низкоконтрастные стены на планах БТИ не детектируются
   - **Точность: ~60-70%** на реальных планах

2. **Ложные детекции**
   - Мебель, текст, штриховка распознаются как стены
   - Нет фильтрации по контексту
   - Много "мусорных" коротких сегментов

3. **Коробочные модели не работают**
   - **SAM2** сегментирует мебель вместо комнат
   - **EasyOCR** распознаёт только 50-60% текста на планах
   - Pretrained веса не заточены под архитектурные чертежи

4. **Геометрические артефакты**
   - Snap to axis искажает непрямые углы
   - Слияние сегментов иногда объединяет разные стены
   - Нет учёта толщины стен

### Технические ограничения:

- **Производительность:** 10-20 секунд на план (CPU only)
- **Память:** требуется минимум 4GB RAM
- **Масштаб:** нет автоматической калибровки (пиксели, не метры)

---

## Что требуется для Production

### 1. Дообучение моделей (критично!)

**Проблема:** Коробочные решения дают точность ~60-70%, что недостаточно.

**Решение:**
```
Собрать датасет:
  • 500-1000 размеченных планов
  • Разметка: стены (линии), комнаты (полигоны), двери, окна
  • Источники: БТИ, архитектурные бюро, CAD экспорты

Fine-tune модели:
  • YOLO v8/v11 для детекции стен + дверей/окон
  • UNet/DeepLab для сегментации комнат
  • Custom OCR для размеров (на базе CRNN)

Ожидаемый результат:
  • Точность детекции стен: 90-95%
  • F1-score для комнат: >0.85
```

### 2. Улучшение Pipeline

**Текущие проблемы → Решения:**

| Проблема | Решение | Приоритет |
|----------|---------|-----------|
| Разрывы в стенах | Graph-based connectivity + morphological closing | Высокий |
| Мебель как стены | Контекстная фильтрация через classifier | Высокий |
| Толщина стен | Морфологическая эрозия + расширение | Средний |
| Кривые линии | Полиномиальная аппроксимация вместо snap-to-axis | Средний |
| Масштаб | OCR размеров + автокалибровка | Низкий |

### 3. Расширение функционала

```python
# Текущая версия (v1.0)
{
  "walls": [...],  # есть, но неточно
  "rooms": [],     # отключено (низкая точность)
  "doors": [],     # не реализовано
  "windows": []    # не реализовано
}

# Целевая версия (v2.0)
{
  "walls": [...],      # точность 90-95%
  "rooms": [...],      # площади + типы помещений
  "doors": [...],      # позиции + типы
  "windows": [...],    # позиции + размеры
  "dimensions": [...], # размеры из OCR
  "scale": 0.05        # метры/пиксель
}
```

---

## Следующая итерация (v2.0)

### Краткосрочные задачи (1-2 месяца):

1. **Сбор и разметка датасета**
   - 500+ планов различных типов
   - Разметка в CVAT/LabelBox
   - Аугментация данных (rotation, noise, blur)

2. **Fine-tuning YOLO v11**
   - Обучение на датасете стен
   - Transfer learning от COCO
   - Ожидаемая точность: 90%+

3. **Улучшение фильтрации**
   - Правила на основе геометрии
   - ML-классификатор "стена/не стена"
   - Post-processing через графовые алгоритмы

### Среднесрочные (3-6 месяцев):

4. **Сегментация комнат**
   - Custom UNet на датасете
   - Интеграция с OCR для типов помещений
   - Watershed от стен как границ

5. **Детекция дверей/окон**
   - Отдельный YOLO детектор
   - Классификация типов
   - Привязка к стенам

6. **API и веб-интерфейс**
   - REST API с документацией
   - Web UI для визуализации
   - Batch обработка

### Долгосрочные (6-12 месяцев):

7. **3D реконструкция**
   - Высота помещений из планов + разрезов
   - Экспорт в 3D форматы (OBJ, FBX)

8. **AR/VR интеграция**
   - Просмотр распознанных планов в AR
   - Virtual walkthrough

---

## Запуск

```bash
# 1. Создайте settings_secret.json с токеном TG бота
echo '{"telegram_bot_token":"YOUR_TOKEN","hybrid_url":"http://localhost:8003/detect"}' > settings_secret.json

# 2. Запустите Docker
docker-compose up -d

# 3. Отправьте план в Telegram бота
```

Подробнее: [DOCKER.md](DOCKER.md) | [QUICKSTART.md](QUICKSTART.md)